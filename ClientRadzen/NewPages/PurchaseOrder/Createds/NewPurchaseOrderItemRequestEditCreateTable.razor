<RadzenRow class="rz-mt-2">
    <RadzenColumn Size="12" SizeMD="MaxColumn">
        <RadzenDataGrid @ref="ordersGrid" AllowAlternatingRows="false" AllowFiltering="false" AllowPaging="true" PageSize="5"
                        AllowSorting="false" EditMode="DataGridEditMode.Single" Density="@Density" AllowRowSelectOnRowClick=true
                        Data="@MainPage.PurchaseOrderItems" TItem="NewPurchaseOrderCreateItemRequest" RowDoubleClick=EditRow Responsive=true
                        CellClick=ClickCell
                        ColumnWidth="200px">

            <Columns>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.BudgetItem.NomenclatoreName)"
                                      Title="Budget Item" Width="70px">
                    <Template Context="detail">
                        @if (detail.BudgetItemId == Guid.Empty)
                        {
                            @("Add Item")
                        }
                        else
                        {
                            @detail.BudgetItem.NomenclatoreName
                        }

                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId == Guid.Empty)
                        {
                            <RadzenDropDown @bind-Value=@ItemToAdd Data=@MainPage.BudgetItems Style="width: 100%;"
                                            Change="@(()=>AddNewItem(order))"
                                            Name="budgetitem" TextProperty="NomenclatoreName"
                                            AllowClear=true
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith"
                                            AllowFiltering="true"
                                            TValue="NewBudgetItemToCreatePurchaseOrderResponse" />
                        }
                        else
                        {
                            <RadzenText Text="@order.BudgetItem.NomenclatoreName"></RadzenText>
                        }
                    </EditTemplate>

                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest" Property="@nameof(NewPurchaseOrderCreateItemRequest.Name)"
                                      Title="PO Item Name" Width="70px">
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            <RadzenTextBox @bind-Value="@order.Name" Style="width:100%"
                                           @oninput="@((arg)=>MainPage.ChangeName(order,arg.Value!.ToString()!))"></RadzenTextBox>

                        }
                    </EditTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.Quantity)"
                                      Title="Qty" Width="30px">
                    <Template Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            @order.Quantity

                        }
                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {

                            <RadzenNumeric ShowUpDown=false @bind-Value=@order.Quantity
                                           @oninput="@((arg)=>MainPage.ChangeQuantity(order,arg.Value!.ToString()!))">
                            </RadzenNumeric>
                            <ValidationMessage For="() => order.Quantity" style="color:red; font-size:x-small;" />
                        }



                    </EditTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.ItemQuoteValueCurrency)"
                                      Title="@($"Value, {Model.QuoteCurrency.Name}")"
                                      Width="70px">
                    <Template Context="detail">
                        @if (detail.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.ItemQuoteValueCurrency)

                        }

                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            <TemplateEditDouble @bind-Value=@order.UnitaryValueCurrency
                                                OnKeyDown="@((arg)=>OnKeyDownCurrency(arg,order))"
                                                Change="@(()=>MainPage.ChangeCurrencyValue(order,order.UnitaryValueCurrency))"></TemplateEditDouble>



                        }



                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.POValueCurrency)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Title="@($"Value, {Model.PurchaseOrderCurrency.Name}")" Width="30px"
                                      Visible="@(!IsSameCurrency)">
                    <Template Context="detail">
                        @if (detail.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.UnitaryValueCurrency)
                        }

                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.UnitaryValueCurrency)
                        }

                    </EditTemplate>

                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.ItemQuoteValueUSD)"
                                      Title="Total, USD" Width="30px">
                    <Template Context="detail">
                        @if (detail.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.ItemQuoteValueUSD)
                        }

                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.ItemQuoteValueUSD)
                        }

                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.POValueUSD)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.BudgetUSD)"
                                      Title="Budget" Width="30px">
                    <Template Context="detail">
                        @if (detail.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.BudgetUSD)
                        }

                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.BudgetUSD)
                        }
                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.TotalBudgetUSD)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.BudgetAssignedUSD)"
                                      Title="Assigned" Width="30px">
                    <Template Context="detail">
                        @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.BudgetAssignedUSD)
                    </Template>
                    <EditTemplate Context="order">
                        @String.Format(new CultureInfo("en-US"), "{0:C0}", order.BudgetAssignedUSD)
                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.NewTotalAssignedUSD)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.NewPotentialUSD)"
                                      Title="Potential" Width="30px">
                    <Template Context="detail">
                        @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.NewPotentialUSD)
                    </Template>
                    <EditTemplate Context="order">
                        @String.Format(new CultureInfo("en-US"), "{0:C0}", order.NewPotentialUSD)
                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.NewTotalPotentialUSD)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest"
                                      Property="@nameof(NewPurchaseOrderCreateItemRequest.PendingToCommitmUSD)"
                                      Title="Pending" Width="30px">
                    <Template Context="detail">
                        @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.PendingToCommitmUSD)
                    </Template>
                    <EditTemplate Context="order">
                        @String.Format(new CultureInfo("en-US"), "{0:C0}", order.PendingToCommitmUSD)
                    </EditTemplate>
                    <FooterTemplate>
                        <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.NewTotalPendingToCommitUSD)}")</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>


                <RadzenDataGridColumn TItem="NewPurchaseOrderCreateItemRequest" Context="order" Filterable="false" Sortable="false"
                                      TextAlign="TextAlign.Right" Width="25px">
                    <Template Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                          MouseEnter="@(args => MainApp.ShowTooltip(args,$"Edit", TooltipPosition.Top) )"
                                          Click="@(args => EditRowButton(order))" @onclick:stopPropagation="true">
                            </RadzenButton>
                            @if (order.BudgetItemId != Model.MainBudgetItemId)
                            {
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter"
                                              MouseEnter="@(args => MainApp.ShowTooltip(args,$"Delete", TooltipPosition.Left) )"
                                              Size="ButtonSize.ExtraSmall" class="my-1 ms-1" Click="@(args => DeleteRow(order))" @onclick:stopPropagation="true">
                                </RadzenButton>
                            }
                        }
                    </Template>
                    <EditTemplate Context="order">
                        @if (order.BudgetItemId != Guid.Empty)
                        {
                            <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                          Click="@((args) => SaveRow(order))" MouseEnter="@(args => MainApp.ShowTooltip(args,$"Save", TooltipPosition.Top) )">
                            </RadzenButton>
                            <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                          class="my-1 ms-1" Click="@((args) => CancelEdit(order))" MouseEnter="@(args => MainApp.ShowTooltip(args,$"Cancel", TooltipPosition.Left) )">
                            </RadzenButton>
                        }
                    </EditTemplate>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenColumn>
</RadzenRow>

@code {
    bool IsSameCurrency => Model == null ? false : Model.QuoteCurrency.Id == Model.PurchaseOrderCurrency.Id;
}
