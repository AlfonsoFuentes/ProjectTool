@page "/EditPurchaseOrderApproved/{PurchaseorderId:guid}"


<PageTitle>Edit Purchase Order </PageTitle>
@if (debug)
{

}
@if (Model != null)
{

    <RadzenStack Orientation="Orientation.Vertical">
        <RadzenRow>
            <RadzenText TextStyle="TextStyle.DisplayH5"
                        Text="@($"Edit Purchase Order {Model.PONumber} in {Model.MWOCECName} {Model.MWOName} ")"></RadzenText>
        </RadzenRow>


        <EditForm Model="@Model" OnValidSubmit="ValidateAsync">
            <FluentValidationValidator @ref="_fluentValidationValidator" />
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Purchase order Number" Style="width: 100%;">
                        <RadzenTextBox @bind-Value=@Model.PONumber class="w-100"
                                       @oninput="@((arg)=>ChangePONumber(arg.Value!.ToString()!))"
                                       Name="PONumber" />

                    </RadzenFormField>
                    <ValidationMessage For="() => Model.PONumber" style="color:red; font-size:x-small;" />


                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Purchase order Expected date" Style="width: 100%;">
          

                         <RadzenDatePicker @bind-Value=@Model.ExpectedDate AllowClear=true DateFormat="d" ShowCalendarWeek
                                           Change=ChangedExpectedDate
                                          TValue="DateTime?">

                        </RadzenDatePicker>

                    </RadzenFormField>
                    <ValidationMessage For="() => Model.ExpectedDate" style="color:red; font-size:x-small;" />


                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Purchase order Name" Style="width: 100%;">
                        <RadzenTextBox @bind-Value=@Model.PurchaseorderName class="w-100"
                                       @oninput="@((arg)=>ChangeName(arg.Value!.ToString()!))"
                                       Name="name" />

                    </RadzenFormField>
                    <ValidationMessage For="() => Model.PurchaseorderName" style="color:red; font-size:x-small;" />
                </RadzenColumn>


            </RadzenRow>

          
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Supplier" Style="width: 100%;">
                        <RadzenDropDown @bind-Value=@Model.Supplier Data=@Suppliers
                                        Name="supplier" TextProperty="Name"
                                        Placeholder="Select Supplier"
                                        Change="@(()=>SetSupplier(Model.Supplier!))"
                                        AllowClear=true
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith"
                                        AllowFiltering="true"
                                        TValue="SupplierResponse?" />



                    </RadzenFormField>
                    <ValidationMessage For="() => Model.Supplier" style="color:red; font-size:x-small;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenButton Text="Add Supplier" Icon="support" Click="CreateSupplier" Style="width: 100%;" class="mt-2"
                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Add new Supplier", TooltipPosition.Top) )"></RadzenButton>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">

                    <RadzenFormField Text="Vendor Code" Style="width: 100%; height:100%">
                        <RadzenText Text=@Model.VendorCode class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                    </RadzenFormField>

                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">

                    <RadzenFormField Text="Tax Code" Style="width: 100%; height:100%">
                        <RadzenText Text=@Model.TaxCode class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                    </RadzenFormField>

                </RadzenColumn>
            </RadzenRow>
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Purchase Requisition" Style="width: 100%;">
                        <RadzenTextBox @bind-Value=@Model.PurchaseRequisition class="w-100"
                                       @oninput="@((arg)=>ChangePR(arg.Value!.ToString()!))"
                                       Name="pr" />

                    </RadzenFormField>
                    <ValidationMessage For="() => Model.PurchaseRequisition" style="color:red; font-size:x-small;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Quote No" Style="width: 100%;">
                        <RadzenTextBox @bind-Value=@Model.QuoteNo class="w-100"
                                       @oninput="@((arg)=>ChangeQuote(arg.Value!.ToString()!))"
                                       Name="quoteno" />

                    </RadzenFormField>
                    <ValidationMessage For="() => Model.QuoteNo" style="color:red; font-size:x-small;" />
                </RadzenColumn>
                @if (Model.IsAlteration)
                {
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Account" Style="width: 100%;">

                            <RadzenText Text=@Model.AccountAssigment class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="MWO" Style="width: 100%;">

                            <RadzenText Text=@Model.MWOCECName class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                }
                else
                {
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Account" Style="width: 100%;">

                            <RadzenText Text=@Model.AccountAssigment class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                        </RadzenFormField>
                    </RadzenColumn>
                }
                
            </RadzenRow>
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Quote Currency" Style="width: 100%;">

                        <RadzenDropDown @bind-Value=@Model.QuoteCurrency Data=@CurrencyEnum.List Style="width: 100%;"
                                        AllowClear=true
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith"
                                        AllowFiltering="true" Disabled=Model.IsAlteration
                                        Change="@(()=>ChangeQuoteCurrency(Model.QuoteCurrency))"
                                        Name="type" TextProperty="Name"
                                        TValue="CurrencyEnum" />
                    </RadzenFormField>
                    <ValidationMessage For="() => Model.QuoteCurrency" style="color:red; font-size:x-small;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    @if (Model.PurchaseOrderCurrency.Id == CurrencyEnum.COP.Id)
                    {
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenFormField Text=@($"PO TRM ") Style="width: 100%;">
                                    <RadzenNumeric ShowUpDown=false @bind-Value=@Model.USDCOP class="w-100"
                                                   @oninput="@((arg)=>ChangeTRMUSDCOP(arg.Value!.ToString()!))"
                                                   Name="usdcop" />

                                </RadzenFormField>
                                <ValidationMessage For="() => Model.USDCOP" style="color:red; font-size:x-small;" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="2" class="rz-mt-2">
                                @if (UpdateCurrentTRM)
                                {
                                    <RadzenButton Icon="attach_money" Click=ClickUpdateOldTRM
                                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Update PO TRM {Model.OldTRMUSDCOP} COP/USD",
                                              TooltipPosition.Top))"></RadzenButton>
                                }
                                else
                                {
                                    <RadzenButton Icon="attach_money" Click=ClickUpdateCurrentTRM
                                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Update current TRM {MainApp.USDCOPLabel} COP/USD",
                                              TooltipPosition.Top))"></RadzenButton>
                                }
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenFormField Text=@($"Today TRM") Style="width: 100%;">

                                    <RadzenText Text=@MainApp.USDCOPLabel class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>



                        </RadzenRow>

                    }
                    else if (Model.PurchaseOrderCurrency.Id == CurrencyEnum.EUR.Id)
                    {
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenFormField Text=@($"PO TRM ") Style="width: 100%;">
                                    <RadzenNumeric ShowUpDown=false @bind-Value=@Model.USDEUR class="w-100"
                                                   @oninput="@((arg)=>ChangeTRMUSDEUR(arg.Value!.ToString()!))"
                                                   Name="usdeur" />

                                </RadzenFormField>
                                <ValidationMessage For="() => Model.USDEUR" style="color:red; font-size:x-small;" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="2">
                                @if (UpdateCurrentTRM)
                                {
                                    <RadzenButton Icon="attach_money" Click=ClickUpdateOldTRM
                                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Update PO TRM {Model.OldTRMUSDEUR} EUR/USD",
                                              TooltipPosition.Top))"></RadzenButton>
                                }
                                else
                                {
                                    <RadzenButton Icon="attach_money" Click=ClickUpdateCurrentTRM
                                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Update current TRM {MainApp.USDEURLabel} EUR/USD",
                                              TooltipPosition.Top))"></RadzenButton>
                                }
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenFormField Text=@($"Today TRM") Style="width: 100%;">

                                    <RadzenText Text=@MainApp.USDEURLabel class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                    }
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="PO Currency" Style="width: 100%;">
                        <RadzenText Text=@Model.PurchaseOrderCurrency.Name class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />


                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="SPL" Style="width: 100%;">
                        <RadzenText Text=@Model.SPL class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;" />


                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>


            <RadzenRow class="rz-mt-2">
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenButton Click="@SaveAsync" Variant="Variant.Flat" Text="@($"Edit PO {Model.PONumber}")" Disabled=@(!Validated)
                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Edit PO {Model.PONumber}", TooltipPosition.Top) )" Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenButton Click="@Cancel" Variant="Variant.Flat" ButtonStyle="ButtonStyle.Light" Text="Cancel" Style="width: 100%"
                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Cancel", TooltipPosition.Top) )" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenRow>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenRow>
                                <RadzenFormField Text="PO Value, $USD" Style="width: 100%;">
                                    <RadzenText class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;">
                                        <b>@($"{String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", Model.SumPOValueUSD)}")</b>
                                    </RadzenText>

                                </RadzenFormField>
                                <ValidationMessage For="() => Model.IsAnyValueNotDefined" style="color:red; font-size:x-small;" />
                                <ValidationMessage For="() => Model.SumPOValueUSD" style="color:red; font-size:x-small;" />
                            </RadzenRow>

                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            @if (Model.PurchaseOrderCurrency.Id != CurrencyEnum.USD.Id && Model.PurchaseOrderCurrency.Id != CurrencyEnum.None.Id)
                            {
                                <RadzenFormField Text=@($"PO Value, ${Model.PurchaseOrderCurrency.Name}") Style="width: 100%; height:100%">
                                    <RadzenText class=@UISettings.TextBoxWithFieldNameclass Style="width: 100%;">
                                        <b>@($"{String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", Model.SumPOValueCurrency)}")</b>
                                    </RadzenText>
                                </RadzenFormField>


                            }
                        </RadzenColumn>

                    </RadzenRow>
                </RadzenColumn>



            </RadzenRow>

            @if (debug)
            {

            }
            <CascadingValue Value="@Model">
                <DataGridForPurchaseOrderItems BudgetItems="@BudgetItems" OriginalBudgetItems="@OriginalBudgetItems"
                                               ValidateAsync="@ValidateAsync"></DataGridForPurchaseOrderItems>
            </CascadingValue>

        </EditForm>


    </RadzenStack>
}


@code {
    bool IsSameCurrency => Model.QuoteCurrency.Id == Model.PurchaseOrderCurrency.Id;
}
