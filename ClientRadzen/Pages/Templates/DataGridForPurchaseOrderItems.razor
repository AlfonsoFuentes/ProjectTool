@if (Model != null)
{
    <RadzenRow class="rz-mt-2">
        <RadzenColumn Size="12" SizeMD="MaxColumn">
            <RadzenDataGrid @ref="ordersGrid" AllowAlternatingRows="false" AllowFiltering="false" AllowPaging="true" PageSize="5"
                            AllowSorting="false" EditMode="DataGridEditMode.Single" Density="@Density" AllowRowSelectOnRowClick=true
                            Data="@Model.PurchaseOrderItems" TItem="PurchaseOrderItemRequest" RowDoubleClick=EditRow Responsive=true
                            CellClick=ClickCell
                            ColumnWidth="200px">

                <Columns>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.BudgetItemName)"
                                          Title="Item Id" Width="50px">
                        <Template Context="detail">
                            @if (detail.BudgetItemId == Guid.Empty)
                            {
                                @("Add Item")
                            }
                            else
                            {
                                @detail.BudgetItemName
                            }

                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId == Guid.Empty)
                            {
                                <RadzenDropDown @bind-Value=@ItemToAdd Data=@BudgetItems Style="width: 100%;"
                                                Change="@(()=>AddNewItem(order))"
                                                Name="budgetitem" TextProperty="NomenclatoreName"
                                                AllowClear=true
                                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith"
                                                AllowFiltering="true"
                                                TValue="BudgetItemApprovedResponse" />
                            }
                            else
                            {
                                <RadzenText Text="@order.BudgetItemName"></RadzenText>
                            }
                        </EditTemplate>

                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest" Property="@nameof(PurchaseOrderItemRequest.Name)"
                                          Title="PO Item Name" Width="50px">
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                <RadzenTextBox @bind-Value="@order.Name" Style="width:100%"
                                               @oninput="@((arg)=>ChangeName(order,arg.Value!.ToString()!))"></RadzenTextBox>

                            }
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.Quantity)"
                                          Title="Qty" Width="20px">
                        <Template Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                @order.Quantity

                            }
                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {

                                  <RadzenNumeric ShowUpDown=false @bind-Value=@order.Quantity
                                               @oninput="@((arg)=>ChangeQuantity(order,arg.Value!.ToString()!))">
                                </RadzenNumeric> 
                                <ValidationMessage For="() => order.Quantity" style="color:red; font-size:x-small;" />
                            }



                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.QuoteCurrencyValue)"
                                          Title="@($"Value, {Model.QuoteCurrency.Name}")"
                                          Width="100px">
                        <Template Context="detail">
                            @if (detail.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.QuoteCurrencyValue)

                            }

                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                <TemplateEditDouble @bind-Value=@order.QuoteCurrencyValue
                                                    Change="@(()=>ChangeCurrencyValue(order,order.QuoteCurrencyValue))"></TemplateEditDouble>
                     

                            
                            }



                        </EditTemplate>
                        <FooterTemplate>
                            <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.SumPOValueCurrency)}")</b>
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Title="@($"Value, {Model.PurchaseOrderCurrency.Name}")" Width="30px"
                                          Visible="@(!IsSameCurrency)">
                        <Template Context="detail">
                            @if (detail.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.UnitaryValuePurchaseOrderCurrency)
                            }

                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new CultureInfo("en-US"), "{0:C0}", order.UnitaryValuePurchaseOrderCurrency)
                            }

                        </EditTemplate>

                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.PurchaseOrderValueUSD)"
                                          Title="Total, USD" Width="30px">
                        <Template Context="detail">
                            @if (detail.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.PurchaseOrderValueUSD)
                            }

                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new CultureInfo("en-US"), "{0:C0}", order.PurchaseOrderValueUSD)
                            }

                        </EditTemplate>
                        <FooterTemplate>
                            <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.SumPOValueUSD)}")</b>
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.BudgetUSD)"
                                          Title="Budget" Width="30px">
                        <Template Context="detail">
                            @if (detail.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.BudgetUSD)
                            }

                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                @String.Format(new CultureInfo("en-US"), "{0:C0}", order.BudgetUSD)
                            }
                        </EditTemplate>
                        <FooterTemplate>
                            <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.SumBudget)}")</b>
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.NewAssignedUSD)"
                                          Title="Assigned" Width="30px">
                        <Template Context="detail">
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.NewAssignedUSD)
                        </Template>
                        <EditTemplate Context="order">
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.NewAssignedUSD)
                        </EditTemplate>
                        <FooterTemplate>
                            <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.SumBudgetAssigned)}")</b>
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.NewPotencialUSD)"
                                          Title="Potential" Width="30px">
                        <Template Context="detail">
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.NewPotencialUSD)
                        </Template>
                        <EditTemplate Context="order">
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.NewPotencialUSD)
                        </EditTemplate>
                        <FooterTemplate>
                            <b>@($"{String.Format(new CultureInfo("en-US"), "{0:C0}", Model.SumBudgetPotencial)}")</b>
                        </FooterTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest"
                                          Property="@nameof(PurchaseOrderItemRequest.PendingToCommitmUSD)"
                                          Title="Pending" Width="30px">
                        <Template Context="detail">
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C0}", detail.PendingToCommitmUSD)
                        </Template>
                        <EditTemplate Context="order">
                            @String.Format(new CultureInfo("en-US"), "{0:C0}", order.PendingToCommitmUSD)
                        </EditTemplate>

                    </RadzenDataGridColumn>


                    <RadzenDataGridColumn TItem="PurchaseOrderItemRequest" Context="order" Filterable="false" Sortable="false"
                                          TextAlign="TextAlign.Right" Width="25px">
                        <Template Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                              MouseEnter="@(args => MainApp.ShowTooltip(args,$"Edit", TooltipPosition.Top) )"
                                              Click="@(args => EditRowButton(order))" @onclick:stopPropagation="true">
                                </RadzenButton>
                                @if (order.BudgetItemId != Model.MainBudgetItemId)
                                {
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter"
                                                  MouseEnter="@(args => MainApp.ShowTooltip(args,$"Delete", TooltipPosition.Left) )"
                                                  Size="ButtonSize.ExtraSmall" class="my-1 ms-1" Click="@(args => DeleteRow(order))" @onclick:stopPropagation="true">
                                    </RadzenButton>
                                }
                            }
                        </Template>
                        <EditTemplate Context="order">
                            @if (order.BudgetItemId != Guid.Empty)
                            {
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                              Click="@((args) => SaveRow(order))" MouseEnter="@(args => MainApp.ShowTooltip(args,$"Save", TooltipPosition.Top) )">
                                </RadzenButton>
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall"
                                              class="my-1 ms-1" Click="@((args) => CancelEdit(order))" MouseEnter="@(args => MainApp.ShowTooltip(args,$"Cancel", TooltipPosition.Left) )">
                                </RadzenButton>
                            }
                        </EditTemplate>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
}


@code {
    bool IsSameCurrency => Model == null ? false : Model.QuoteCurrency.Id == Model.PurchaseOrderCurrency.Id;
}
